  // determine top score
  const top = list.slice().sort((a,b)=>b.score-a.score)[0];
  document.getElementById('topName').innerText = top ? top.name : '—';
  document.getElementById('topScore').innerText = top ? (top.score + ' pts') : '—';
  // show up to last 10 (most recent first)
  const last = list.slice(0,10);
  last.forEach(item=>{
    const el = document.createElement('div'); el.className='leaderboard-item';
    el.innerHTML = `<div style="font-weight:800">${escapeHtml(item.name)}</div><div class="tiny">${item.score} pts • ${new Date(item.date).toLocaleString()}</div>`;
    div.appendChild(el);
  });
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

/* ===== GAME FLOW ===== */
startBtn.addEventListener('click', ()=>{
  const name = playerNameInput.value.trim();
  if(!name){ alert('Coloque seu nome para começar.'); playerNameInput.focus(); return; }
  state.name = name;
  state.index = 0; state.score = 0;
  registerScreen.style.display='none'; quizArea.style.display=''; endScreen.style.display='none';
  renderQuestion(); renderSidebar();
});

function renderQuestion(){
  clearTimer();
  const q = QUESTIONS[state.index];
  qIndex.innerText = `Pergunta ${state.index+1} / ${QUESTIONS.length}`;
  questionText.innerText = q.q;
  choicesList.innerHTML = '';
  q.choices.forEach((c, idx)=>{
    const el = document.createElement('div'); el.className='choice'; el.dataset.idx = idx;
    el.innerHTML = `<div style="width:30px;height:30px;border-radius:8px;background:linear-gradient(90deg,var(--accentA),var(--accentB));display:flex;align-items:center;justify-content:center;color:white;font-weight:800">${String.fromCharCode(65+idx)}</div><div>${escapeHtml(c)}</div>`;
    el.addEventListener('click', ()=> {
      // silently score and advance
      if(Number(idx) === Number(q.answer)) state.score += POINTS_PER_QUESTION;
      clearTimer();
      state.index++;
      if(state.index >= QUESTIONS.length) finishGame(); else renderQuestion();
    });
    choicesList.appendChild(el);
  });
  progressPct.innerText = `Progresso: ${Math.round((state.index/QUESTIONS.length)*100)}%`;
  startTimer();
}

function startTimer(){
  clearTimer();
  state.timerId = setTimeout(()=>{
    // timeout: treat as no answer and advance
    state.index++;
    if(state.index >= QUESTIONS.length) finishGame(); else renderQuestion();
  }, SECONDS_PER_QUESTION * 1000);
}
function clearTimer(){ if(state.timerId){ clearTimeout(state.timerId); state.timerId = null; } }

function finishGame(){
  clearTimer();
  quizArea.style.display='none'; endScreen.style.display='';
  finalScore.innerText = `${state.score} pts`;
  // save to LB (most recent first)
  const lb = loadLB(); lb.unshift({ name: state.name, score: state.score, date: new Date().toISOString() });
  saveLB(lb);
  showEndBoard();
}

function showEndBoard(){
  const list = loadLB().slice(0,20);
  if(list.length===0){ endBoard.innerHTML = '<div class="tiny muted">Nenhum resultado ainda.</div>'; return; }
  let html = '<div style="font-weight:800;margin-bottom:8px">Últimos jogadores (local)</div>';
  list.forEach(it=>{
    html += `<div style="display:flex;justify-content:space-between;padding:8px;border-radius:8px;border:1px dashed rgba(15,23,42,0.04);margin-bottom:6px"><div><strong>${escapeHtml(it.name)}</strong><div class="tiny" style="color:var(--muted)">${new Date(it.date).toLocaleString()}</div></div><div style="font-weight:900">${it.score} pts</div></div>`;
  });
  endBoard.innerHTML = html;
}

/* controls (no replay button) */
document.getElementById('clearBoard').addEventListener('click', ()=>{ if(confirm('Apagar todos os resultados locais?')){ localStorage.removeItem(leaderboardKey); renderSidebar(); alert('Placar apagado.'); } });
document.getElementById('exportBtn').addEventListener('click', ()=>{ const list = loadLB(); if(list.length===0){ alert('Nenhum resultado para exportar.'); return; } const blob = new Blob([JSON.stringify(list, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='placar_imunizaquiz.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });

/* init */
renderSidebar();

/* accessibility: Enter to start */
document.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && registerScreen.style.display !== 'none') startBtn.click(); });
</script>
</body>
</html>
